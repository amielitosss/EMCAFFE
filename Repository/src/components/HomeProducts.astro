---
import { productService } from '@/lib/api/productService';
import type { Product, ProductVariant } from "@/lib/api/types/product.types";
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

let products: Product[] = [];

try {
  const response = await productService.getAllProducts();
  if (response && Array.isArray(response.data)) {
    products = response.data;
  }
} catch (err) {
  console.error("âŒ Erreur API produits:", err);
}

// PrÃ©parer priceMap pour chaque produit
const preparedProducts = products.map(product => {
  const priceMap: Record<string, number> = {};

  (product.variants || []).forEach((v: ProductVariant) => {
    const key = v.format || 'default';
    priceMap[key] = (v.price);
  });

  const defaultFormat = Object.keys(priceMap)[0] || 'default';

  // Si pas de variantes, mettre le prix principal
  if (!priceMap[defaultFormat]) {
    priceMap['default'] = (product.price);
  }

  return {
    ...product,
    priceMap,
    defaultFormat,
  };
});
---

<section class="flex flex-col items-center justify-center py-12">
  <h2 class="mb-8 text-5xl font-[Chalkduster] uppercase text-[#753E1C] text-center">
    {t("home-carousel.title")}
  </h2>

  <div id="carousel-container" class="relative w-[100vw] sm:w-11/12 md:w-3/4 border-2 border-black rounded-2xl bg-[#FEFBED] p-6 sm:p-8 md:p-12 shadow-md overflow-hidden mx-auto">
    <div id="carousel-track" class="flex transition-transform duration-700 ease-in-out gap-3 sm:gap-6">
      {preparedProducts.map(product => (
        <div class="relative flex-shrink-0 flex flex-col items-center justify-between bg-[#ffffff] w-full md:w-1/2 rounded-lg p-4 hover:scale-105 transition-transform">
          <a href={`/${lang}/product/${product.id_product}`} class="w-full">
            <img src={`${product.image_url}-1.png`} alt={product.name} class="w-full h-auto object-contain rounded-md shadow-lg" />
          </a>

          <h3 class="mt-6 text-lg md:text-xl text-primary font-bold leading-tight text-center font-[Chalkduster]">{product.name}</h3>

          <p class="mt-6 border border-gray-300 text-black font-semibold text-lg md:text-xl px-6 py-2 rounded-full font-[Chalkduster]">
            {product.priceMap[product.defaultFormat]}â‚¬
          </p>

          <button
            class="mt-6 bg-black text-white px-6 py-3 rounded-xl hover:bg-[#5C3F32] transition font-semibold shadow-md add-to-cart"
            data-product-id={product.id_product}
            data-product-name={product.name}
            data-product-image={`${product.image_url}-1.png`}
            data-price-map={JSON.stringify(product.priceMap)}
            data-default-format={product.defaultFormat}
          >
            {t("product.addToCart") || "Ajouter au panier"}
          </button>
        </div>
      ))}
    </div>
  </div>
</section>

<script is:inline>
window.addEventListener("DOMContentLoaded", () => {
  const track = document.getElementById("carousel-track");
  const container = document.getElementById("carousel-container");
  const cards = document.querySelectorAll("#carousel-track > div");

  let index = 0;
  let visible = window.innerWidth < 768 ? 1 : 2;
  const total = cards.length;

  function updateVisible() { visible = window.innerWidth < 768 ? 1 : 2; }
  function updateCarousel() {
    if (!track || cards.length === 0) return;
    updateVisible();
    const cardWidth = (cards[0].offsetWidth || 0) + (window.innerWidth < 640 ? 12 : 24);
    const offset = -index * cardWidth;
    track.style.transform = `translateX(${offset}px)`;
  }
  function nextSlide() {
    index = (index + 1) % Math.ceil(total / visible);
    updateCarousel();
  }

  let autoScroll = setInterval(nextSlide, 5000);
  container?.addEventListener("mouseenter", () => clearInterval(autoScroll));
  container?.addEventListener("mouseleave", () => { autoScroll = setInterval(nextSlide, 5000); });

  window.addEventListener("resize", updateCarousel);

  // ===== FONCTIONS UTILITAIRES PANIER =====
  function getCart() {
    try {
      const cart = localStorage.getItem('cart');
      return cart ? JSON.parse(cart) : [];
    } catch (error) {
      console.error('Error reading cart:', error);
      return [];
    }
  }

  function saveCart(cart) {
    try {
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartBadge();
      // Dispatch Ã©vÃ©nement pour synchroniser
      window.dispatchEvent(new CustomEvent('cartUpdated', { detail: cart }));
    } catch (error) {
      console.error('Error saving cart:', error);
    }
  }

  function updateCartBadge() {
    const cart = getCart();
    const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);

    // Mettre Ã  jour tous les badges possibles
    const badges = document.querySelectorAll('.cart-badge, .cart-count, #cart-count, [data-cart-count]');
    
    badges.forEach(badge => {
      if (badge) {
        badge.textContent = totalItems.toString();
        if (badge.hasAttribute('data-cart-count')) {
          badge.setAttribute('data-cart-count', totalItems.toString());
        }
        
        if (totalItems > 0) {
          badge.style.display = 'flex';
          badge.classList.remove('hidden');
        } else {
          badge.style.display = 'none';
          badge.classList.add('hidden');
        }
      }
    });
  }

  // ===== FONCTION GLOBALE ADDTOCART =====
  if (!window.addToCart) {
    window.addToCart = function(product) {
      const cart = getCart();

      const existingIndex = cart.findIndex(
        item => item.id === product.id && item.format === product.format
      );

      if (existingIndex > -1) {
        cart[existingIndex].quantity += product.quantity;
      } else {
        cart.push(product);
      }

      saveCart(cart);
      console.log('âœ… Cart updated:', cart);
      return cart;
    };
  }

  // ===== AJOUTER AU PANIER AVEC POPUP =====
  document.querySelectorAll(".add-to-cart").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const target = e.currentTarget;
      const priceMap = JSON.parse(target.dataset.priceMap || '{}');
      const format = target.dataset.defaultFormat || 'default';
      const price = priceMap[format] ?? 0;

      const product = {
        id: target.dataset.productId,
        name: target.dataset.productName,
        price: parseFloat(price),
        image: target.dataset.productImage,
        format,
        quantity: 1
      };

      console.log("ðŸ›’ Adding to cart:", product);

      // Ajouter au panier
      window.addToCart(product);

      // ðŸŽ‰ OUVRIR LA POPUP
      if (typeof window.dispatchAddToCartModal === 'function') {
        window.dispatchAddToCartModal(product);
      } else {
        console.warn('âš ï¸ dispatchAddToCartModal function not found');
      }

      // Animation du bouton
      target.classList.add("scale-95");
      setTimeout(() => target.classList.remove("scale-95"), 200);
    });
  });

  // ===== Ã‰COUTER LES Ã‰VÃ‰NEMENTS DE PANIER =====
  window.addEventListener("cartUpdated", updateCartBadge);
  window.addEventListener("storage", (e) => {
    if (e.key === "cart") {
      updateCartBadge();
    }
  });

  // Initialiser le carousel et le badge
  updateCarousel();
  updateCartBadge();
});
</script>


