---
import { productService } from '@/lib/api/productService';
import type { Product, ProductVariant } from '@/lib/api/types/product.types';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

let products: Product[] = [];

try {
	const response = await productService.getAllProducts();
	if (response && Array.isArray(response.data)) {
		products = response.data;
	}
} catch (err) {
	console.error('❌ Erreur API produits:', err);
}

// Préparer le variant le moins cher pour chaque produit
const preparedProducts = products.map(product => {
  const variants: ProductVariant[] = product.variants || [];
  const cheapestVariant = variants.sort((a, b) => a.price - b.price)[0] || null;
  return {
    ...product,
    cheapestVariant,
  };
});
---

<section class="flex flex-col items-center justify-center py-12">
  <h2 class="mb-8 text-center font-[Chalkduster] text-5xl uppercase text-[#753E1C]">
    {t('home-carousel.title')}
  </h2>

  <div
    id="carousel-container"
    class="relative mx-auto w-[100vw] overflow-hidden rounded-2xl border-2 border-black bg-[#FEFBED] p-6 shadow-md sm:w-11/12 sm:p-8 md:w-3/4 md:p-12"
  >
    <div
      id="carousel-track"
      class="flex gap-3 transition-transform duration-700 ease-in-out sm:gap-6"
    >
      {preparedProducts.map((product) => (
        <div class="relative flex w-full flex-shrink-0 flex-col items-center justify-between rounded-lg bg-[#ffffff] p-4 transition-transform hover:scale-105 md:w-1/2">
          <a href={`/${lang}/product/${product.id_product}`} class="w-full">
            <img
              src={`${product.image_url}-1.png`}
              alt={product.name}
              class="h-auto w-full rounded-md object-contain shadow-lg"
            />
          </a>

          <h3 class="mt-6 text-center font-[Chalkduster] text-lg font-bold leading-tight text-primary md:text-xl">
            {product.name}
          </h3>

          <p class="mt-6 rounded-full border border-gray-300 px-6 py-2 font-[Chalkduster] text-lg font-semibold text-black md:text-xl">
            {product.cheapestVariant?.price ?? product.price}€
          </p>

          <a
            href={`/${lang}/product/${product.id_product}`}
            class="mt-6 inline-block bg-black text-white px-6 py-3 rounded-xl hover:bg-[#5C3F32] transition font-semibold shadow-md text-center"
          >
            {t('product.details') || 'Détails'}
          </a>
        </div>
      ))}
    </div>
  </div>
</section>

<script is:inline>
window.addEventListener('DOMContentLoaded', () => {
  const track = document.getElementById('carousel-track');
  const container = document.getElementById('carousel-container');
  const cards = document.querySelectorAll('#carousel-track > div');

  let index = 0;
  let visible = window.innerWidth < 768 ? 1 : 2;
  const total = cards.length;

  function updateVisible() {
    visible = window.innerWidth < 768 ? 1 : 2;
  }
  function updateCarousel() {
    if (!track || cards.length === 0) return;
    updateVisible();
    const cardWidth = (cards[0].offsetWidth || 0) + (window.innerWidth < 640 ? 12 : 24);
    const offset = -index * cardWidth;
    track.style.transform = `translateX(${offset}px)`;
  }
  function nextSlide() {
    index = (index + 1) % Math.ceil(total / visible);
    updateCarousel();
  }

  let autoScroll = setInterval(nextSlide, 5000);
  container?.addEventListener('mouseenter', () => clearInterval(autoScroll));
  container?.addEventListener('mouseleave', () => {
    autoScroll = setInterval(nextSlide, 5000);
  });

  window.addEventListener('resize', updateCarousel);
  updateCarousel();
});
</script>
