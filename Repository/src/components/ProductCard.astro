---
interface Props {
  img: string;
  productName: string;
  price: number;
  id: string;
  description: string;
  ingredient: string;
  preparation: string;
  dimension: string;
  tabTitles: { ingredient: string; preparation: string; description: string };
  t: (key: string) => string;
  intensity?: number;
  dosage?: string;
  coffeeType?: string;
  price_1kg?: number;
}

const {
  img,
  productName,
  price,
  price_1kg,
  id,
  description,
  ingredient,
  preparation,
  dimension,
  tabTitles,
  t,
  intensity = 7,
  dosage = '7-9g',
  coffeeType = 'Pur Arabica',
} = Astro.props as Props;

function formatTextWithLineBreaks(text: string): string[] {
  return text?.split('\n') ?? [];
}
---

<div class="m-5 -mt-24 md:m-10 md:mt-0">
  <h2 class="mb-8 text-center text-2xl font-bold text-[#5C3F32] sm:text-3xl lg:text-4xl">
    {productName}
  </h2>

  <div class="flex flex-col lg:flex-row lg:items-start lg:gap-8">
    <!-- COLONNE GAUCHE - Images -->
    <div class="flex flex-col items-center lg:sticky lg:top-24 lg:w-1/2 lg:self-start">
      <div class="mb-6 w-full max-w-2xl lg:max-w-none">
        <img
          id="image"
          class="h-auto w-full rounded-lg bg-white object-cover shadow-lg"
          src={`${img}-1.png`}
          data-img={`${img}`}
          alt={productName}
        />
      </div>

      <div class="mb-8 flex flex-row justify-center gap-3 lg:mb-0">
        <button id="button1" class="w-20 rounded-lg border-2 border-[#5C3F32] p-2 transition hover:border-[#A47343] sm:w-24 lg:w-28">
          <img class="h-auto w-full rounded bg-white" src={`${img}-1.png`} alt="Image 1" />
        </button>
        <button id="button2" class="w-20 rounded-lg border-2 border-[#5C3F32] p-2 transition hover:border-[#A47343] sm:w-24 lg:w-28">
          <img class="h-auto w-full rounded bg-white" src={`${img}-2.png`} alt="Image 2" />
        </button>
      </div>
    </div>

    <!-- COLONNE DROITE -->
    <div class="flex flex-col items-center lg:w-1/2">
      <div class="flex w-full max-w-xl flex-col items-center px-4 text-center lg:px-0">
        <h3 class="mb-3 text-lg font-semibold text-[#5C3F32] sm:text-xl">{t('product.format')}</h3>

        <div class="mb-4 flex gap-3">
          <button id="btn-250" class="active rounded-lg bg-[#A47343] px-4 py-2 font-semibold text-white transition hover:bg-[#8B4513] sm:px-5 sm:py-2.5">500g</button>
          <button id="btn-1000" class="rounded-lg border-2 border-[#A47343] px-4 py-2 font-semibold text-[#A47343] transition hover:bg-[#A47343] hover:text-white sm:px-5 sm:py-2.5">1kg</button>
        </div>

        <div class="mb-6 flex items-center gap-4">
          <span id="price" class="text-3xl font-bold text-[#5C3F32] sm:text-4xl">{price}€</span>
          <div class="flex items-center rounded-lg border-2 border-[#5C3F32]">
            <button id="btn-minus" class="px-3 py-2 transition hover:bg-gray-100">-</button>
            <input type="number" id="quantity" value="1" min="1" class="w-16 border-x-2 border-[#5C3F32] py-2 text-center focus:outline-none" />
            <button id="btn-plus" class="px-3 py-2 transition hover:bg-gray-100">+</button>
          </div>
        </div>

        <button
          id="addToCart"
          class="mb-6 w-full max-w-sm transform rounded-lg bg-[#5C3F32] px-8 py-3 font-bold text-white shadow-lg transition hover:scale-105 hover:bg-[#8B4513]"
          data-product-id={id}
          data-product-name={productName}
          data-product-price={price}
          data-product-image={`${img}-1.png`}
        >
          {t('product.addToCart')}
        </button>

        <p class="mb-6 text-sm text-gray-600">{dimension}</p>
      </div>

      <!-- Tabs -->
      <div class="mt-8 w-full max-w-2xl rounded-lg bg-white p-4 shadow-lg sm:p-6">
        <div class="mb-4 flex justify-center overflow-x-auto border-b border-gray-200">
          <button class="tablinks whitespace-nowrap border-b-2 border-[#5C3F32] px-4 py-2 font-semibold text-[#5C3F32]" data-tab="ingredient">{tabTitles.ingredient}</button>
          <button class="tablinks whitespace-nowrap px-4 py-2 font-semibold text-gray-500 transition hover:text-[#5C3F32]" data-tab="preparation">{tabTitles.preparation}</button>
          <button class="tablinks whitespace-nowrap px-4 py-2 font-semibold text-gray-500 transition hover:text-[#5C3F32]" data-tab="description">{tabTitles.description}</button>
        </div>

        <div id="ingredient" class="tabcontent">
          {formatTextWithLineBreaks(ingredient).map((line) => <p class="mb-2 text-gray-700">{line}</p>)}
        </div>
        <div id="preparation" class="tabcontent hidden">
          {formatTextWithLineBreaks(preparation).map((line) => <p class="mb-2 text-gray-700">{line}</p>)}
        </div>
        <div id="description" class="tabcontent hidden">
          {formatTextWithLineBreaks(description).map((line) => <p class="mb-2 text-gray-700">{line}</p>)}
        </div>
      </div>

      <!-- Info Cards -->
      <div class="mt-8 w-full max-w-md px-4 lg:px-0">
        <div class="grid grid-cols-2 gap-3 sm:gap-4">
          <!-- Intensité -->
          <div class="transform rounded-lg bg-gradient-to-br from-[#5C3F32] to-[#8B4513] p-3 text-white shadow-md transition-all hover:scale-105 sm:p-5">
            <div class="flex h-full flex-col items-center justify-center">
              <svg class="mb-2 h-6 w-6 sm:mb-3 sm:h-10 sm:w-10" fill="currentColor" viewBox="0 0 20 20">
                <path d="M11.983 1.907a.75.75 0 00-1.292-.657l-8.5 9.5A.75.75 0 002.75 12h6.572l-1.305 6.093a.75.75 0 001.292.657l8.5-9.5A.75.75 0 0017.25 8h-6.572l1.305-6.093z"></path>
              </svg>
              <h3 class="mb-2 text-center text-sm font-bold sm:text-base">{t('product.intensity')}</h3>
              <div class="mb-2 flex gap-1">
                {Array.from({ length: 10 }).map((_, i) => (
                  <div class={`h-2 w-2 rounded-full sm:h-3 sm:w-3 ${i < intensity ? 'bg-white' : 'bg-white/30'}`} />
                ))}
              </div>
              <p class="text-xs opacity-90 sm:text-sm">{intensity}/10</p>
            </div>
          </div>

          <!-- Type de café -->
          <div class="transform rounded-lg bg-gradient-to-br from-[#6B4423] to-[#5C3F32] p-3 text-white shadow-md transition-all hover:scale-105 sm:p-5">
            <div class="flex h-full flex-col items-center justify-center">
              <svg class="mb-2 h-6 w-6 sm:mb-3 sm:h-8 sm:w-8" fill="currentColor" viewBox="0 0 22 25">
                <path fill-rule="evenodd" d="M19.151,4.868a6.744,6.744,0,0,0-5.96-1.69..." clip-rule="evenodd"></path>
              </svg>
              <h3 class="mb-2 text-center text-sm font-bold sm:text-base">{t('product.type')}</h3>
              <p class="mb-1 text-center text-sm font-bold leading-tight sm:text-lg">{coffeeType}</p>
              <p class="text-center text-xs opacity-90 sm:text-sm">{t('product.origin')}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const img = document.getElementById('image')?.getAttribute('data-img') ?? '';
  const quantityInput = document.getElementById('quantity') as HTMLInputElement | null;
  const btnMinus = document.getElementById('btn-minus');
  const btnPlus = document.getElementById('btn-plus');
  const addToCartBtn = document.getElementById('addToCart');
  const btn250 = document.getElementById('btn-250');
  const btn1000 = document.getElementById('btn-1000');
  const priceEl = document.getElementById('price');

  type Format = '500g' | '1kg';
  let selectedFormat: Format = '500g';
  const priceMap: Record<Format, number> = {
    '500g': parseFloat(addToCartBtn?.dataset.productPrice ?? '16.99'),
    '1kg': parseFloat(addToCartBtn?.dataset.productPrice_1kg ?? '33.98'),
  };

  btnMinus?.addEventListener('click', () => {
    if (quantityInput && parseInt(quantityInput.value) > 1) {
      quantityInput.value = String(parseInt(quantityInput.value) - 1);
    }
  });
  btnPlus?.addEventListener('click', () => {
    if (quantityInput) quantityInput.value = String(parseInt(quantityInput.value) + 1);
  });

  function changeImage(base: string, num: string) {
    const imgEl = document.getElementById('image') as HTMLImageElement | null;
    if (imgEl) imgEl.src = `${base}-${num}.png`;
  }
  document.getElementById('button1')?.addEventListener('click', () => changeImage(img, '1'));
  document.getElementById('button2')?.addEventListener('click', () => changeImage(img, '2'));

  function openTab(tabName: string) {
    document.querySelectorAll<HTMLElement>('.tabcontent').forEach(tab => tab.classList.add('hidden'));
    document.querySelectorAll<HTMLElement>('.tablinks').forEach(link => {
      link.classList.remove('border-b-2','border-[#5C3F32]','text-[#5C3F32]');
      link.classList.add('text-gray-500');
    });
    document.getElementById(tabName)?.classList.remove('hidden');
    document.querySelector<HTMLElement>(`.tablinks[data-tab="${tabName}"]`)?.classList.add('border-b-2','border-[#5C3F32]','text-[#5C3F32]');
  }
  document.querySelectorAll<HTMLElement>('.tablinks').forEach(button => {
    button.addEventListener('click', () => {
      const tabName = button.getAttribute('data-tab');
      if (tabName) openTab(tabName);
    });
  });
  openTab('ingredient');

  // Format toggle
  if (btn250 && btn1000 && priceEl) {
    btn250.addEventListener('click', () => {
      selectedFormat = '500g';
      priceEl.textContent = priceMap[selectedFormat].toFixed(2) + '€';
      btn250.classList.add('bg-[#A47343]','text-white','border-[#A47343]');
      btn250.classList.remove('border-2');
      btn1000.classList.remove('bg-[#A47343]','text-white');
      btn1000.classList.add('border-2','border-[#A47343]','text-[#A47343]');
    });
    btn1000.addEventListener('click', () => {
      selectedFormat = '1kg';
      priceEl.textContent = priceMap[selectedFormat].toFixed(2) + '€';
      btn1000.classList.add('bg-[#A47343]','text-white','border-[#A47343]');
      btn1000.classList.remove('border-2');
      btn250.classList.remove('bg-[#A47343]','text-white');
      btn250.classList.add('border-2','border-[#A47343]','text-[#A47343]');
    });
  }

  addToCartBtn?.addEventListener('click', () => {
    const quantityValue = parseInt(quantityInput?.value ?? '1');
    const product = {
      id: addToCartBtn.dataset.productId,
      name: addToCartBtn.dataset.productName,
      price: priceMap[selectedFormat],
      image: addToCartBtn.dataset.productImage,
      quantity: quantityValue,
      format: selectedFormat
    };
    window.addToCart?.(product);
    window.dispatchAddToCartModal?.(product);
  });
});
</script>


<style>
  .tabcontent.hidden { display: none; }
  .tabcontent { display: block; }
</style>
