<!-- Composant Points Relais -->
<div id="relaySearchComponent" class="space-y-4 bg-white p-4 rounded-lg border border-[#A47343] max-w-full md:max-w-3xl mx-auto">
  <h4 class="font-semibold text-[#5C3F32] text-lg md:text-xl">üìç Trouvez votre point relais</h4>

  <!-- Champs de recherche -->
  <div class="flex flex-col sm:flex-row gap-2">
    <input id="postcodeInput" type="text" placeholder="Code postal" 
      class="border border-[#A47343] p-2 rounded focus:outline-none focus:ring-2 focus:ring-[#A47343] flex-1" />
    <input id="cityInput" type="text" placeholder="Ville (optionnel)" 
      class="border border-[#A47343] p-2 rounded focus:outline-none focus:ring-2 focus:ring-[#A47343] flex-1" />
    <button id="searchBtn" type="button"
      class="bg-[#5C3F32] text-white px-4 py-2 rounded hover:bg-[#A47343] transition w-full sm:w-auto">
      Rechercher
    </button>
  </div>

  <p id="status" class="text-sm text-center md:text-left"></p>

  <!-- Carte -->
  <div id="map" class="w-full h-64 md:h-96 rounded border border-[#A47343] mt-4"></div>

  <!-- Liste des points relais -->
  <ul id="pointsList" class="space-y-2 mt-4 max-h-64 overflow-y-auto"></ul>

  <!-- Point relais s√©lectionn√© -->
  <div id="selectedRelayInfo" class="hidden mt-4 p-4 bg-green-50 rounded border-2 border-green-300">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
      <div class="flex-1">
        <div class="font-semibold text-green-800">‚úÖ Point relais s√©lectionn√©</div>
        <div class="text-sm mt-2">
          <div id="selectedRelayName" class="font-medium"></div>
          <div id="selectedRelayAddress" class="text-gray-600 mt-1"></div>
          <div id="selectedRelayCarrier" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded inline-block mt-1"></div>
        </div>
      </div>
      <button type="button" id="changeRelay" class="text-sm text-[#5C3F32] hover:underline font-medium self-start md:self-auto">
        Modifier
      </button>
    </div>
  </div>
</div>


<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" is:inline></script>

<script is:inline>
window.addEventListener('DOMContentLoaded', () => {
  // Variables globales
  let selectedRelayPoint = null;
  let relayMap = null;
  let relayMarkers = [];
  let normalizedPoints = [];

  // R√©cup√©ration des donn√©es d'un point
  function getRelayData(point) {
    return {
      id: point.id || point.code,
      name: point.name || 'Sans nom',
      street: point.street || point.raw?.street || '',
      house_number: point.house_number || point.raw?.house_number || '',
      address: point.address || '',
      postal_code: point.postal_code || point.raw?.postal_code || '',
      city: point.city || point.raw?.city || '',
      latitude: parseFloat(point.latitude ?? point.raw?.latitude ?? '0'),
      longitude: parseFloat(point.longitude ?? point.raw?.longitude ?? '0'),
      carrier: point.carrier || point.raw?.carrier || '',
      phone: point.phone || point.raw?.phone || '',
      email: point.email || point.raw?.email || '',
      raw: point.raw || point
    };
  }

  // Affichage du statut
  function showStatus(message, type = 'info') {
    const statusEl = document.getElementById('status');
    if (!statusEl) return;
    const colors = {
      info: 'text-blue-500',
      success: 'text-green-600',
      warning: 'text-orange-500',
      error: 'text-red-500'
    };
    statusEl.textContent = message;
    statusEl.className = `text-sm ${colors[type] || colors.info}`;
  }

  // Initialisation de la carte
  function initRelayMap(lat = 46.603354, lng = 1.888334, zoom = 6) {
    if (typeof L === 'undefined') {
      console.error('‚ùå Leaflet non charg√©');
      showStatus('Erreur: Leaflet non charg√©', 'error');
      return null;
    }
    const mapElement = document.getElementById('map');
    if (!mapElement) return null;

    if (relayMap) relayMap.remove();

    relayMap = L.map('map').setView([lat, lng], zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(relayMap);
    relayMarkers = [];
    return relayMap;
  }

  const searchBtn = document.getElementById('searchBtn');
  const postcodeInput = document.getElementById('postcodeInput');
  const cityInput = document.getElementById('cityInput');
  const pointsList = document.getElementById('pointsList');
  const selectedRelayInfo = document.getElementById('selectedRelayInfo');
  const selectedRelayName = document.getElementById('selectedRelayName');
  const selectedRelayAddress = document.getElementById('selectedRelayAddress');
  const selectedRelayCarrier = document.getElementById('selectedRelayCarrier');
  const changeRelayBtn = document.getElementById('changeRelay');

  // Recherche des points relais
  async function searchRelayPoints(e) {
    e?.preventDefault();
    e?.stopPropagation();

    const postcode = postcodeInput?.value.trim();
    const city = cityInput?.value.trim();

    if (!postcode || !/^\d{5}$/.test(postcode)) {
      showStatus('Veuillez entrer un code postal valide (5 chiffres)', 'warning');
      return;
    }

    if (searchBtn) {
      searchBtn.disabled = true;
      searchBtn.textContent = 'Recherche...';
    }
    showStatus('Recherche en cours...', 'info');

    const params = new URLSearchParams({ postal_code: postcode, country: 'FR' });
    if (city) params.append('city', city);

    const url = `https://api-emcafe-3.onrender.com/api/sendcloud/service-points?${params.toString()}`;

    try {
      const response = await fetch(url, { cache: 'no-cache' });
      if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
      const data = await response.json();

let points = Array.isArray(data) ? data : (data.data || []);
points = points.filter(point => point.carrier === 'colissimo');
      if (points.length === 0) {
        showStatus('Aucun point relais trouv√© pour ce code postal', 'warning');
        pointsList.innerHTML = '<li class="border p-3 rounded text-gray-500 text-center">Aucun point relais disponible.</li>';
        return;
      }

      showStatus(`${points.length} point(s) relais trouv√©(s)`, 'success');

      normalizedPoints = points.map(getRelayData);

      // Recr√©er la carte centr√©e sur le premier point
      const firstPoint = normalizedPoints[0];
      relayMap = initRelayMap(firstPoint.latitude, firstPoint.longitude, 13);

      const customIcon = L.divIcon({
  className: 'custom-marker',
  html: `<span style="font-size: 28px;">üìç</span>`,
  iconSize: [28, 28],
  iconAnchor: [14, 28]
});
      pointsList.innerHTML = '';

      normalizedPoints.forEach((point, index) => {
        const marker = L.marker([point.latitude, point.longitude], { icon: customIcon })
          .addTo(relayMap)
          .bindPopup(`
            <div class="text-sm">
              <strong>${point.name}</strong><br>
              ${point.street} ${point.house_number}<br>
              ${point.postal_code} ${point.city}<br>
              ${point.phone ? `üìû ${point.phone}<br>` : ''}
              <span style="background:#3b82f6;color:white;padding:2px 6px;border-radius:4px;font-size:11px;">
                ${point.carrier}
              </span>
              <br><br>
              <button onclick="window.selectRelayFromMap(${index})" 
                style="background:#5C3F32;color:white;padding:6px 12px;border-radius:4px;border:none;cursor:pointer;width:100%;font-size:12px;font-weight:500;"
                onmouseover="this.style.background='#A47343'" 
                onmouseout="this.style.background='#5C3F32'">
                ‚úÖ S√©lectionner ce point relais
              </button>
            </div>
          `);

        marker.on('click', () => { selectRelayPoint(point); highlightListItem(index); });
        relayMarkers.push(marker);

        const li = document.createElement('li');
        li.className = 'border border-[#A47343] p-3 rounded hover:bg-[#f9f4ee] cursor-pointer transition';
        li.innerHTML = `
          <div class="flex justify-between items-start gap-2">
            <div class="flex-1">
              <div class="font-semibold text-[#5C3F32]">${point.name}</div>
              <div class="text-sm text-gray-600 mt-1">${point.street} ${point.house_number}</div>
              <div class="text-sm text-gray-600">${point.postal_code} ${point.city}</div>
              ${point.phone ? `<div class="text-xs text-gray-500 mt-1">üìû ${point.phone}</div>` : ''}
              <div class="mt-2">
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${point.carrier}</span>
              </div>
            </div>
            <button type="button" class="select-relay-btn bg-[#5C3F32] text-white px-3 py-1 rounded text-sm hover:bg-[#A47343] transition flex-shrink-0" data-index="${index}">S√©lectionner</button>
          </div>
        `;

        li.addEventListener('click', (e) => {
          if (!e.target.classList.contains('select-relay-btn')) {
            relayMap.setView([point.latitude, point.longitude], 15);
            marker.openPopup();
          }
        });

        li.querySelector('.select-relay-btn')?.addEventListener('click', (e) => {
          e.stopPropagation();
          selectRelayPoint(point);
          highlightListItem(index);
        });

        pointsList.appendChild(li);
      });
    } catch (err) {
      console.error('Erreur recherche points relais:', err);
      showStatus(`Erreur: ${err.message}`, 'error');
      pointsList.innerHTML = '<li class="border p-3 rounded text-red-500 text-center">Erreur lors de la r√©cup√©ration des points relais.</li>';
    } finally {
      if (searchBtn) { searchBtn.disabled = false; searchBtn.textContent = 'Rechercher'; }
    }
  }

  // Highlight item s√©lectionn√©
  function highlightListItem(index) {
    const allItems = pointsList.querySelectorAll('li');
    allItems.forEach(item => item.classList.remove('ring-2', 'ring-green-500', 'bg-green-50'));
    const li = pointsList.children[index];
    if (li) { li.classList.add('ring-2', 'ring-green-500', 'bg-green-50'); li.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
  }

  // S√©lection depuis la popup
  window.selectRelayFromMap = (index) => {
    const point = normalizedPoints[index];
    if (point) { selectRelayPoint(point); highlightListItem(index); relayMarkers[index]?.closePopup(); }
  };

  // S√©lection d‚Äôun point
  function selectRelayPoint(relay) {
    selectedRelayPoint = relay;
    if (selectedRelayName) selectedRelayName.textContent = relay.name;
    if (selectedRelayAddress) selectedRelayAddress.textContent = `${relay.street} ${relay.house_number}, ${relay.postal_code} ${relay.city}`;
    if (selectedRelayCarrier) selectedRelayCarrier.textContent = relay.carrier;
    selectedRelayInfo?.classList.remove('hidden');
    window.dispatchEvent(new CustomEvent('relay-selected', { detail: relay }));
    selectedRelayInfo?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  searchBtn?.addEventListener('click', searchRelayPoints);
  postcodeInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') searchRelayPoints(e); });
  cityInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') searchRelayPoints(e); });

  changeRelayBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    selectedRelayPoint = null;
    selectedRelayInfo?.classList.add('hidden');
    pointsList.querySelectorAll('li').forEach(item => item.classList.remove('ring-2', 'ring-green-500', 'bg-green-50'));
    window.dispatchEvent(new CustomEvent('relay-deselected'));
  });

  window.getSelectedRelayPoint = () => selectedRelayPoint;

  // Initialisation de la carte vide
  initRelayMap();
});
</script>


<style>
  #map { z-index:0; }
  .custom-marker { background:transparent; border:none; }
</style>
