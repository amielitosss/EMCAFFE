---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import ProductCard from '@/components/ProductCard.astro';

import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { productService } from '@/lib/api/productService';
import type { Product } from '@/lib/api/types/product.types';

// Astro params
const { id } = Astro.params as { id: string; lang: string };
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang as 'en' | 'fr' | 'es');

let product: Product | null = null;
let errorMessage = '';

try {
  console.log('üîç R√©cup√©ration du produit ID:', id);
  
  const result = await productService.getProductWithVariants(id);
  
  console.log('üì¶ R√©sultat brut API:', JSON.stringify(result, null, 2));
  
  // ‚úÖ V√©rifier la structure de la r√©ponse
  if (result && result.success && result.data) {
    product = result.data;
    console.log('‚úÖ Produit r√©cup√©r√©:', product);
  } else if (result && result.data) {
    // Certaines API retournent directement data sans success
    product = result.data;
    console.log('‚úÖ Produit r√©cup√©r√© (format alternatif):', product);
  } else if (result) {
    // Peut-√™tre que result EST directement le produit
    product = result as unknown as Product;
    console.log('‚úÖ Produit r√©cup√©r√© (format direct):', product);
  }
  
  // Validation finale
  if (!product || !product.id_product) {
    console.error('‚ùå Produit invalide:', product);
    errorMessage = 'Produit invalide ou incomplet';
    product = null;
  }
  
} catch (err) {
  console.error('‚ùå Erreur lors de la r√©cup√©ration du produit :', err);
  errorMessage = err instanceof Error ? err.message : 'Erreur inconnue';
  product = null;
}

// Tabs et contenus
const tabTitles = {
  ingredient: t('tab.ingredient'),
  preparation: t('tab.preparation'),
  description: t('tab.description'),
};

// Valeurs par d√©faut s√©curis√©es
const translatedTitle = product?.name || 'Produit inconnu';
const price = product?.price || 0;
const img = product?.image_url || '/img/default-product.png';
const description = product?.description || '';
const ingredient = product?.ingredient || '';
const preparation = product?.preparation || '';
const dimension = product?.size || '';
---

<Layout title={`EMCAFFE - ${translatedTitle}`}>
  <Header />

  <main class="mt-[255px] flex h-auto w-full flex-col md:mt-[192px]">
    {product ? (
      <ProductCard
        img={img}
        productName={translatedTitle}
        price={price}
        id={id}
        description={description}
        ingredient={ingredient}
        preparation={preparation}
        dimension={dimension}
        tabTitles={tabTitles}
        t={t}
        variants={product.variants || []}
      />
    ) : (
      <div class="text-center mt-8">
        <p class="text-gray-500 text-xl mb-4">Produit introuvable.</p>
        {errorMessage && (
          <p class="text-red-500 text-sm">Erreur : {errorMessage}</p>
        )}
        <a href="/shop" class="text-blue-500 hover:underline mt-4 inline-block">
          Retour √† la boutique
        </a>
      </div>
    )}
  </main>

  <Footer />
</Layout>
