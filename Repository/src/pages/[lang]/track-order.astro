---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<Layout title={t('track.title')}>
  <Header />

  <main class="min-h-screen flex items-center justify-center bg-gradient-to-b from-beige to-white pt-32 pb-16">
    <div class="container mx-auto max-w-2xl px-4 w-full">
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <h1 class="text-3xl font-bold text-center text-[#753E1C] mb-2">
          {t('track.title')}
        </h1>
        <p class="text-center text-gray-600 mb-8">
          {t('track.subtitle')}
        </p>

        <!-- Formulaire de recherche -->
        <form id="trackOrderForm" class="space-y-6">
          <div>
            <label for="orderId" class="block text-sm font-semibold text-gray-700 mb-2">
              üìã {t('track.orderId')}
            </label>
            <input
              type="text"
              id="orderId"
              required
              placeholder="a25f20c4-1cfa-4325-b918-6815b06e03c3"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-[#753E1C] focus:ring-2 focus:ring-[#753E1C]/20 transition"
            />
          </div>

          <div>
            <label for="postalCode" class="block text-sm font-semibold text-gray-700 mb-2">
              üìÆ {t('track.postalCode')}
            </label>
            <input
              type="text"
              id="postalCode"
              required
              placeholder="75001"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-[#753E1C] focus:ring-2 focus:ring-[#753E1C]/20 transition"
            />
          </div>

          <button
            type="submit"
            class="w-full bg-[#753E1C] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#5a2f15] transition shadow-lg hover:shadow-xl"
          >
            üîç {t('track.search')}
          </button>
        </form>

        <!-- Messages -->
        <div id="loading" class="hidden text-center py-8">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-[#753E1C] border-t-transparent"></div>
          <p class="mt-4 text-gray-600">{t('track.loading')}</p>
        </div>

        <div id="error" class="hidden mt-6 p-4 bg-red-50 border-2 border-red-200 rounded-lg">
          <p class="text-red-700 font-semibold"></p>
        </div>

        <!-- R√©sultat (sera affich√© apr√®s la recherche) -->
        <div id="orderResult" class="hidden mt-8"></div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<style>
  main {
    min-height: calc(100vh - 192px);
  }

  @media (max-width: 768px) {
    main {
      min-height: calc(100vh - 255px);
    }
  }

  .status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .status-PENDING { background-color: #FEF3C7; color: #92400E; }
  .status-CONFIRMED { background-color: #DBEAFE; color: #1E40AF; }
  .status-SHIPPED { background-color: #E0E7FF; color: #4338CA; }
  .status-DELIVERED { background-color: #D1FAE5; color: #065F46; }
  .status-CANCELLED { background-color: #FEE2E2; color: #991B1B; }

  #orderResult:not(.hidden) {
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  details summary {
    cursor: pointer;
    list-style: none;
  }

  details summary::-webkit-details-marker {
    display: none;
  }

  details summary::before {
    content: '‚ñ∂';
    display: inline-block;
    margin-right: 0.5rem;
    transition: transform 0.2s;
    font-size: 0.75rem;
  }

  details[open] summary::before {
    transform: rotate(90deg);
  }
</style>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000/api';

  const trackOrderForm = document.getElementById('trackOrderForm') as HTMLFormElement;
  const loading = document.getElementById('loading')!;
  const error = document.getElementById('error')!;
  const orderResult = document.getElementById('orderResult')!;
  const mainElement = document.querySelector('main')!;

  trackOrderForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const orderId = (document.getElementById('orderId') as HTMLInputElement).value.trim();
    const postalCode = (document.getElementById('postalCode') as HTMLInputElement).value.trim();

    loading.classList.remove('hidden');
    error.classList.add('hidden');
    orderResult.classList.add('hidden');
    orderResult.innerHTML = '';

    try {
      const response = await fetch(`${API_URL}/track`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId, postalCode })
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.message || 'Commande introuvable');
      }

      mainElement.classList.remove('items-center');
      mainElement.classList.add('items-start');

      await displayOrder(data.data);

    } catch (err: any) {
      error.classList.remove('hidden');
      error.querySelector('p')!.textContent = err.message;
    } finally {
      loading.classList.add('hidden');
    }
  });

  // ‚úÖ Fonction pour r√©cup√©rer les variantes d'un produit
  async function getProductVariants(productId: string) {
    try {
      const response = await fetch(`${API_URL}/products/${productId}/full`);
      if (!response.ok) return [];
      const data = await response.json();
      return data.data?.variants || [];
    } catch (error) {
      console.error('Erreur chargement variantes:', error);
      return [];
    }
  }

 // ‚úÖ Fonction pour construire l'URL compl√®te de l'image
function getImageUrl(imageUrl: string | null | undefined): string {
  if (!imageUrl) {
    return '/img/placeholder-product.jpg';
  }

  // Si l'URL commence d√©j√† par http:// ou https://, la retourner telle quelle
  if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
    return imageUrl;
  }

  // ‚úÖ Si l'image n'a pas d'extension, ajouter -1.png par d√©faut
  const hasExtension = /\.(jpg|jpeg|png|webp|gif)$/i.test(imageUrl);
  let finalUrl = imageUrl;
  
  if (!hasExtension) {
    finalUrl = `${imageUrl}-1.png`;
    console.log('‚ö†Ô∏è Extension manquante, ajout de -1.png:', finalUrl);
  }

  // Si l'URL commence par /uploads/, construire l'URL compl√®te avec le backend
  if (finalUrl.startsWith('/uploads/')) {
    const backendUrl = API_URL.replace('/api', '');
    return `${backendUrl}${finalUrl}`;
  }

  // Si c'est un chemin relatif commen√ßant par /, le retourner tel quel (Astro static)
  if (finalUrl.startsWith('/')) {
    return finalUrl;
  }

  // Si c'est juste un nom de fichier, construire le chemin complet
  const backendUrl = API_URL.replace('/api', '');
  return `${backendUrl}/uploads/${finalUrl}`;
}

  async function displayOrder(order: any) {
    console.log('üì¶ Order data:', order);

    // ‚úÖ Charger les variantes pour chaque produit
    const itemsWithVariants = await Promise.all(
      (order.orderItems || []).map(async (item: any) => {
        const variants = await getProductVariants(item.id_product);
        
        console.log('üñºÔ∏è Image URL brute:', item.product?.image_url);
        const constructedUrl = getImageUrl(item.product?.image_url);
        console.log('üîó Image URL construite:', constructedUrl);
        
        // ‚úÖ Identifier la variante command√©e par ID ou par prix
        let orderedVariant = null;
        
        if (item.id_variant) {
          orderedVariant = variants.find((v: any) => v.id_variant === item.id_variant);
        }
        
        if (!orderedVariant && variants.length > 0) {
          orderedVariant = variants.find((v: any) => 
            Math.abs(Number(v.price) - Number(item.unit_price)) < 0.01
          );
        }
        
        return { ...item, availableVariants: variants, orderedVariant, imageUrl: constructedUrl };
      })
    );

    orderResult.innerHTML = `
      <div class="border-t-4 border-[#753E1C] pt-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-[#753E1C]">
            Commande #${order.id_order.substring(0, 8)}
          </h2>
          <span class="status-badge status-${order.status}">
            ${getStatusLabel(order.status)}
          </span>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mb-6 text-sm">
          <div class="space-y-2">
            <p><strong>üìÖ Date :</strong> ${new Date(order.created_at).toLocaleDateString('fr-FR')}</p>
            ${order.email ? `<p><strong>‚úâÔ∏è Email :</strong> ${order.email}</p>` : ''}
            ${order.delivery_phone ? `<p><strong>üìû T√©l√©phone :</strong> ${order.delivery_phone}</p>` : ''}
          </div>
          <div class="space-y-2">
            ${order.delivery_address ? `
              <p><strong>üìç Adresse :</strong></p>
              <p class="text-gray-700">
                ${order.delivery_address}<br>
                ${order.delivery_postal_code} ${order.delivery_city || ''}
              </p>
            ` : `
              <p><strong>üìç Code postal :</strong> ${order.delivery_postal_code}</p>
            `}
          </div>
        </div>

        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
          <span>üõçÔ∏è</span> Articles command√©s (${itemsWithVariants.length})
        </h3>
        
        <div class="space-y-4 mb-6">
          ${itemsWithVariants.map((item: any) => {
            const productName = item.product?.name || 'Produit inconnu';
            const orderedVariant = item.orderedVariant;
            
            return `
              <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-[#753E1C] transition">
                <div class="flex gap-4">
                  <img 
                    src="${item.imageUrl}" 
                    alt="${productName}"
                    class="w-24 h-24 object-cover rounded-lg flex-shrink-0 bg-gray-100"
                    onerror="this.onerror=null; this.src='/img/placeholder-product.jpg'; console.error('‚ùå Image non trouv√©e:', '${item.imageUrl}')"
                  >
                  
                  <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-lg text-gray-900 mb-2">${productName}</h4>
                    
                    ${orderedVariant?.format ? `
                      <div class="mb-2 bg-emerald-50 border border-emerald-200 px-3 py-1.5 rounded inline-block">
                        <span class="text-sm font-medium text-emerald-700">‚öñÔ∏è ${orderedVariant.format}</span>
                      </div>
                    ` : ''}
                    
                    <div class="mt-3 flex items-center gap-4 text-sm text-gray-600">
                      <span>Quantit√©: <strong class="text-gray-900">${item.quantity}</strong></span>
                      <span>‚Ä¢</span>
                      <span>Prix unitaire: <strong class="text-[#753E1C]">${Number(item.unit_price).toFixed(2)}‚Ç¨</strong></span>
                    </div>
                  </div>
                  
                  <div class="text-right flex-shrink-0">
                    <div class="text-xs text-gray-500 mb-1">Sous-total</div>
                    <div class="font-bold text-2xl text-[#753E1C]">
                      ${Number(item.subtotal).toFixed(2)}‚Ç¨
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        <div class="border-t-2 pt-4 space-y-2 bg-gray-50 p-4 rounded-lg">
          ${order.delivery_cost > 0 ? `
            <div class="flex justify-between text-gray-700">
              <span>Sous-total articles</span>
              <span class="font-semibold">${(Number(order.total) - Number(order.delivery_cost)).toFixed(2)}‚Ç¨</span>
            </div>
            <div class="flex justify-between text-gray-700">
              <span>Frais de livraison</span>
              <span class="font-semibold">${Number(order.delivery_cost).toFixed(2)}‚Ç¨</span>
            </div>
            <div class="border-t pt-2"></div>
          ` : ''}
          <div class="flex justify-between text-2xl font-bold text-[#753E1C]">
            <span>Total TTC</span>
            <span>${Number(order.total).toFixed(2)}‚Ç¨</span>
          </div>
        </div>

        <button 
          id="resetSearch"
          class="mt-6 w-full bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition shadow-sm"
        >
          ‚Üê Nouvelle recherche
        </button>
      </div>
    `;

    orderResult.classList.remove('hidden');

    document.getElementById('resetSearch')?.addEventListener('click', () => {
      orderResult.classList.add('hidden');
      mainElement.classList.remove('items-start');
      mainElement.classList.add('items-center');
      trackOrderForm.reset();
    });
  }

  function getStatusLabel(status: string): string {
    const labels: Record<string, string> = {
      'PENDING': '‚è≥ En attente',
      'CONFIRMED': '‚úÖ Confirm√©e',
      'SHIPPED': 'üöö Exp√©di√©e',
      'DELIVERED': 'üì¶ Livr√©e',
      'CANCELLED': '‚ùå Annul√©e',
    };
    return labels[status] || status;
  }
</script>

    