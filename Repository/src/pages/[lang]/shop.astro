---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import ShopArticle from '@/components/ShopArticle.astro';

import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { productService } from '@/lib/api/productService';
import type { Product } from '@/lib/api/types/product.types';

// üîπ getStaticPaths pour g√©n√©rer les pages par langue
export async function getStaticPaths() {
  const languages = ['en', 'fr', 'es'];
  return languages.map((lang) => ({
    params: { lang },
  }));
}

// ===========================================================
// üîπ R√©cup√©ration des produits depuis l'API
// ===========================================================
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang as 'en' | 'fr' | 'es');

let products: Product[] = [];

try {
  const result = await productService.getAllProducts();
  console.log('API getAllProducts result:', result);

  if (Array.isArray(result)) {
    // Si c'est d√©j√† un tableau
    products = result;
  } else if ('data' in result && Array.isArray(result.data)) {
    // Si c'est un objet ProductListResponse
    products = result.data;
  }
} catch (err) {
  console.error('‚ùå Impossible de r√©cup√©rer les produits :', err);
}

// Fonction utilitaire pour d√©couper un tableau en sous-tableaux
function chunkArray<T>(arr: T[], chunkSize: number): T[][] {
  const result: T[][] = [];
  for (let i = 0; i < arr.length; i += chunkSize) {
    result.push(arr.slice(i, i + chunkSize));
  }
  return result;
}

// On cr√©e des lignes de 2 produits
const productRows = chunkArray(products, 2);
---



<Layout title={`EMCAFFE - ${t('shop.title')}`}>
  <Header />

  <main class="mb-8 mt-[255px] flex h-auto w-full flex-col gap-y-8 md:mt-[192px]">
    {products.length > 0 ? (
      <>
        {productRows.map((row) => (
          <div class="flex w-full flex-col justify-around gap-y-8 md:flex-row md:gap-y-0 uppercase">
            {row.map((product) => (
              <ShopArticle
                title={product.name ?? ''}
                img={product.image_url ?? `/img/products/${product.id_product}`}
                details={`/${lang}/product/${product.id_product}`}
              />
            ))}
          </div>
        ))}
      </>
    ) : (
      <p class="mt-8 text-center text-gray-500">
        {t('shop.noProducts') || 'Aucun produit disponible.'}
      </p>
    )}
  </main>

  <Footer />
</Layout>